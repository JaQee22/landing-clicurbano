<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administrador - ClicUrbano</title>
    <!-- 1. Tailwind CSS para estilos rápidos --><script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. SDKs de Firebase (ES Modules) --><script type="module">
        // Importamos los servicios que necesitamos
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        // --- ¡CAMBIO AQUÍ! ---
        // Añadimos 'setPersistence' y 'browserSessionPersistence'
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // --- FIN DEL CAMBIO ---
        
        // Importamos Firestore
        import { getFirestore, collection, onSnapshot, doc, getDoc, updateDoc, query, orderBy, where, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Importamos Storage
        import { getStorage, ref, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAoYm_Jc358AkK3MJf-ZJb9AZkxEi1V6Co", // <--- REEMPLAZAR
            authDomain: "clicurbano-ec989.firebaseapp.com", // <--- REEMPLAZAR
            projectId: "clicurbano-ec989", // <-- ¡Este ya lo sabemos!
            storageBucket: "clicurbano-ec989.firebasestorage.app", // <--- REEMPLAZAR
            messagingSenderId: "356402457239", // <--- REEMPLAZAR
            appId: "1:356402457239:android:01b5287b8d941e4b7797d2" // <--- REEMPLAZAR
            // (El appId de 'web' puede ser diferente al de 'android',
            // búscalo en la configuración de tu proyecto en Firebase)
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Referencias a los elementos de la página
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const loginForm = document.getElementById('login-form');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginError = document.getElementById('login-error');
        const currentUserEmail = document.getElementById('current-user-email');
        const logoutButton = document.getElementById('logout-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const reportsTableBody = document.getElementById('reports-table-body');
        
        // Referencia al display de comuna
        const comunaDisplay = document.getElementById('comuna-display');

        // --- LÓGICA DE AUTENTICACIÓN (Actualizada con Persistencia) ---

        // 1. Escuchar el envío del formulario de login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            loginError.classList.add('hidden'); 
            const email = loginEmail.value;
            const password = loginPassword.value;

            try {
                // --- ¡CAMBIO AQUÍ! ---
                // Configurar la persistencia a 'SESSION' antes de iniciar sesión.
                // Esto asegura que al cerrar la pestaña, se cierre la sesión.
                await setPersistence(auth, browserSessionPersistence);
                // --- FIN DEL CAMBIO ---

                await signInWithEmailAndPassword(auth, email, password);
                // El 'onAuthStateChanged' se encargará del resto
            } catch (error) {
                console.error("Error de login:", error.message);
                loginError.textContent = "Error: Usuario o contraseña incorrectos.";
                loginError.classList.remove('hidden');
            }
        });

        // 2. Escuchar el botón de cerrar sesión
        logoutButton.addEventListener('click', () => {
            signOut(auth);
        });

        // 3. Escuchador principal de estado (Login / Logout)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Usuario ha iniciado sesión
                loadingIndicator.textContent = 'Verificando permisos...';
                loadingIndicator.classList.remove('hidden');
                
                // Buscamos el documento del admin
                const adminDocRef = doc(db, 'administrators', user.email);
                const adminDocSnap = await getDoc(adminDocRef);

                if (adminDocSnap.exists()) {
                    const adminData = adminDocSnap.data();
                    const userRole = adminData.role;
                    const userComuna = adminData.comuna_asignada;
                    
                    console.log(`Admin ${user.email} logueado. Rol: ${userRole}, Comuna: ${userComuna}`);

                    // Mostrar comuna si corresponde
                    if (userRole === 'admin_comuna' && userComuna) {
                        comunaDisplay.textContent = `(Comuna: ${userComuna})`;
                        comunaDisplay.classList.remove('hidden');
                    } else {
                        comunaDisplay.classList.add('hidden');
                    }

                    // Mostrar dashboard
                    loginSection.classList.add('hidden'); 
                    dashboardSection.classList.remove('hidden'); 
                    currentUserEmail.textContent = user.email;
                    loadReports(userRole, userComuna);
                    
                } else {
                    console.error("Error: El usuario no tiene permisos de administrador.");
                    loginError.textContent = "Error: No tienes permisos para acceder a este panel.";
                    loginError.classList.remove('hidden');
                    signOut(auth);
                }
                
            } else {
                // Usuario ha cerrado sesión
                loginSection.classList.remove('hidden'); 
                dashboardSection.classList.add('hidden'); 
                currentUserEmail.textContent = '';
                reportsTableBody.innerHTML = '';
                comunaDisplay.classList.add('hidden');
            }
        });

        // --- LÓGICA DEL DASHBOARD ---

        // 1. Cargar y mostrar los reportes
        function loadReports(role, comuna) {
            loadingIndicator.textContent = 'Cargando reportes...';
            reportsTableBody.innerHTML = '';

            let reportsQuery;

            if (role === 'superadmin') {
                reportsQuery = query(collection(db, 'reports'), orderBy('timestamp', 'desc'));
            } else if (role === 'admin_comuna' && comuna) {
                reportsQuery = query(
                    collection(db, 'reports'),
                    where('comuna', '==', comuna),
                    orderBy('timestamp', 'desc')
                );
            } else {
                loadingIndicator.textContent = 'Error: Tu usuario admin no tiene una comuna asignada.';
                return;
            }

            onSnapshot(reportsQuery, (snapshot) => {
                loadingIndicator.classList.add('hidden'); 
                reportsTableBody.innerHTML = ''; 

                if (snapshot.empty) {
                    reportsTableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No hay reportes para tu comuna.</td></tr>';
                    return;
                }

                snapshot.forEach(docSnap => {
                    const report = docSnap.data();
                    const reportId = docSnap.id; 
                    const imageFileName = report.imageFileName || '';

                    let formattedDate = 'N/A';
                    if (report.timestamp) {
                        formattedDate = new Date(report.timestamp.seconds * 1000).toLocaleString('es-CL');
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <a href="${report.imageUrl || ''}" target="_blank">
                                <img src="${report.imageUrl || ''}" alt="Evidencia" class="h-16 w-16 object-cover rounded-md hover:scale-110 transition-transform">
                            </a>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${report.descripcion || 'N/A'}</div>
                            <div class="text-sm text-gray-500">Comuna: ${report.comuna || 'N/A'}</div>
                            <div class="text-sm text-gray-500">Fecha: ${formattedDate}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${report.userRUT || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${createStatusBadge(report.estado || 'Pendiente')}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex items-center space-x-2">
                                <select data-id="${reportId}" class="status-select rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500">
                                    <option value="Pendiente" ${report.estado === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                    <option value="En Proceso" ${report.estado === 'En Proceso' ? 'selected' : ''}>En Proceso</option>
                                    <option value="Finalizado" ${report.estado === 'Finalizado' ? 'selected' : ''}>Finalizado</option>
                                </select>
                                
                                <button data-id="${reportId}" data-image="${imageFileName}" class="delete-button text-gray-400 hover:text-red-600 p-1 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 6h6v10H7V6zm2 2v6h2V8H9z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    `;
                    reportsTableBody.appendChild(row);
                });

                document.querySelectorAll('.status-select').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const newStatus = e.target.value;
                        const docId = e.target.dataset.id;
                        updateReportStatus(docId, newStatus);
                    });
                });
                
                document.querySelectorAll('.delete-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const reportId = e.currentTarget.dataset.id;
                        const imageFileName = e.currentTarget.dataset.image;
                        _deleteReport(reportId, imageFileName);
                    });
                });

            }, (error) => {
                console.error("Error al cargar reportes: ", error);
                if (error.code === 'failed-precondition') {
                     loadingIndicator.textContent = 'Error: Falta un índice. Revisa la consola (F12).';
                } else if (error.code === 'permission-denied') {
                     loadingIndicator.textContent = 'Error: Permisos denegados.';
                } else {
                     loadingIndicator.textContent = 'Error al cargar reportes.';
                }
            });
        }

        // --- Función de Borrado ---
        async function _deleteReport(reportId, imageFileName) {
            if (!confirm('¿Estás seguro de que deseas eliminar este reporte? Esta acción no se puede deshacer.')) {
                return;
            }
            console.log(`Eliminando reporte ${reportId}`);
            try {
                if (imageFileName) {
                    const imageRef = ref(storage, `report_images/${imageFileName}`);
                    await deleteObject(imageRef);
                }
                const reportRef = doc(db, 'reports', reportId);
                await deleteDoc(reportRef);
            } catch (error) {
                console.error("Error al eliminar: ", error);
                if (error.code !== 'storage/object-not-found') {
                    alert("Error: " + error.message);
                } else {
                    // Si la imagen no existe, borramos el documento igual
                    try {
                        await deleteDoc(doc(db, 'reports', reportId));
                    } catch (e) {
                        alert("Error: " + e.message);
                    }
                }
            }
        }

        // --- Función de Actualizar Estado ---
        async function updateReportStatus(docId, newStatus) {
            console.log(`Actualizando ${docId} a ${newStatus}`);
            const reportRef = doc(db, 'reports', docId); 
            try {
                await updateDoc(reportRef, {
                    estado: newStatus
                });
                console.log("¡Estado actualizado!");
            } catch (error) {
                console.error("Error al actualizar: ", error);
            }
        }
        
        function createStatusBadge(status) {
            let colorClasses = 'bg-gray-100 text-gray-800'; 
            if (status === 'Pendiente') colorClasses = 'bg-red-100 text-red-800';
            if (status === 'En Proceso') colorClasses = 'bg-yellow-100 text-yellow-800';
            if (status === 'Finalizado') colorClasses = 'bg-green-100 text-green-800';
            
            return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${colorClasses}">
                        ${status}
                    </span>`;
        }
    </script>
</head>
<body class="h-full bg-gray-100 font-sans">
    
    <!-- Contenedor Principal --><div class="min-h-full">

        <!-- SECCIÓN DE LOGIN (Visible por defecto) -->
        <div id="login-section" class="py-12 sm:px-6 lg:px-8">
            
            <!-- Logo Arriba Izquierda -->
            <div class="px-4 sm:px-6 lg:px-8">
                <img class="h-[250px] w-auto" 
                     src="https://firebasestorage.googleapis.com/v0/b/clicurbano-ec989.firebasestorage.app/o/assets%2Flogo.png?alt=media&token=d3ac2051-7f6d-4f3f-b715-0717ae186d3c" 
                     alt="Logo ClicUrbano">
            </div>
            
            <!-- Título centrado -->
            <div class="sm:mx-auto sm:w-full sm:max-w-md">
                <h2 class="mt-6 text-center text-4xl font-extrabold text-gray-900">
                    Panel de Administración
                </h2>
            </div>

            <!-- Formulario centrado -->
            <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
                <div class="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10">
                    <form id="login-form" class="space-y-6">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-700"> Correo Electrónico </label>
                            <div class="mt-1">
                                <input id="login-email" name="email" type="email" autocomplete="email" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm">
                            </div>
                        </div>

                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-700"> Contraseña </label>
                            <div class="mt-1">
                                <input id="login-password" name="password" type="password" autocomplete="current-password" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm">
                            </div>
                        </div>

                        <!-- Mensaje de Error --><div id="login-error" class="hidden text-sm text-red-600 rounded-md bg-red-50 p-3"></div>

                        <div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                Ingresar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- SECCIÓN DEL DASHBOARD (Oculta por defecto) --><div id="dashboard-section" class="hidden">
            <header class="bg-white shadow-sm">
                <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                    
                    <!-- Div para alinear el título y la comuna -->
                    <div class="flex items-baseline space-x-3">
                        <h1 class="text-xl font-bold text-gray-900">
                            Gestión de Reportes
                        </h1>
                        <!-- Este span mostrará la comuna -->
                        <span id="comuna-display" class="hidden text-lg font-medium text-red-600"></span>
                    </div>
                    
                    <div class="flex items-center">
                        <span class="text-sm text-gray-600 mr-3">
                            Usuario: <span id="current-user-email" class="font-medium"></span>
                        </span>
                        <button id="logout-button" type="button" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            Cerrar Sesión
                        </button>
                    </div>
                </div>
            </header>
            <main>
                <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                    <div class="px-4 py-6 sm:px-0">
                        <div class="flex flex-col">
                            <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                                <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
                                    <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Foto</th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción / Comuna / Fecha</th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario (RUT)</th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acción</th>
                                                </tr>
                                            </thead>
                                            <tbody id="reports-table-body" class="bg-white divide-y divide-gray-200">
                                                <!-- Las filas de reportes se cargarán aquí con JS --></tbody>
                                        </table>
                                        <div id="loading-indicator" class="hidden p-4 text-center text-gray-500">
                                            Cargando...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>

        </div>
    </body>
</html>